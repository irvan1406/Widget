<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display Jam Digital Masjid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Utama -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adhan/3.0.0/Adhan.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #000; color: #fff; margin: 0; }
        .font-digital { font-family: 'Orbitron', sans-serif; }
        .bg-overlay { background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.3), rgba(0,0,0,0.9)); }
        #youtube-container { pointer-events: none; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .marquee-content { display: inline-block; white-space: nowrap; animation: marquee var(--speed) linear infinite; }
        .drop-glow { filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3)); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative overflow-hidden">

    <!-- Layer Background -->
    <div id="bg-color" class="absolute inset-0 z-0 bg-black"></div>
    <div id="bg-image" class="absolute inset-0 z-0 bg-cover bg-center transition-opacity duration-1000 opacity-0"></div>
    <div id="youtube-container" class="absolute inset-0 z-0 opacity-0 transition-opacity duration-1000">
        <div id="player" class="w-full h-full scale-150"></div>
    </div>
    
    <!-- Overlay Transparan -->
    <div class="absolute inset-0 z-10 bg-overlay"></div>

    <!-- Konten Utama (Z-Index 20) -->
    <main class="relative z-20 flex-1 flex flex-col p-12">
        
        <!-- Baris Atas: Tanggal & Jam Realtime -->
        <div class="flex justify-between items-start">
            <div class="text-left drop-glow">
                <!-- Tanggal Masehi Hari Ini -->
                <h1 id="display-date" class="text-5xl font-bold uppercase tracking-widest text-white mb-2">
                    ...
                </h1>
                <!-- Tanggal Hijriah -->
                <p id="display-hijri" class="text-3xl text-yellow-400 font-semibold italic">
                    ...
                </p>
            </div>
            
            <div class="text-right">
                <!-- Jam Digital Utama -->
                <div id="display-clock" class="text-[12rem] font-bold font-digital leading-none text-white drop-shadow-2xl tracking-tighter">
                    00:00:00
                </div>
            </div>
        </div>

        <!-- Area Tengah: Countdown Menuju Sholat -->
        <div class="flex-1 flex flex-col items-center justify-center text-center">
            <div id="status-container" class="space-y-6">
                <h2 id="next-prayer-name" class="text-5xl uppercase tracking-[0.4em] text-gray-300 font-light drop-glow">Menghitung...</h2>
                <div id="prayer-countdown" class="text-[10rem] font-bold font-digital text-yellow-500 tracking-tighter drop-shadow-lg">00:00:00</div>
            </div>
            
            <!-- Alert Waktunya Sholat -->
            <div id="sholat-mode" class="hidden">
                <div class="bg-red-600/80 p-8 rounded-3xl backdrop-blur-md animate-pulse border-4 border-white">
                    <h2 class="text-9xl font-bold text-white uppercase italic">WAKTUNYA SHOLAT</h2>
                    <p id="sholat-name-active" class="text-6xl mt-4 text-yellow-300 font-black tracking-widest"></p>
                </div>
            </div>
        </div>

        <!-- Grid Jadwal Sholat 5 Waktu -->
        <div id="prayer-grid" class="grid grid-cols-5 gap-8 mt-auto">
            <div class="bg-black/60 backdrop-blur-xl border-t-8 border-blue-500 p-8 rounded-3xl text-center shadow-2xl">
                <div class="text-3xl uppercase font-bold text-gray-400">Subuh</div>
                <div id="time-fajr" class="text-6xl font-bold font-digital mt-4 text-white">00:00</div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border-t-8 border-yellow-500 p-8 rounded-3xl text-center shadow-2xl">
                <div class="text-3xl uppercase font-bold text-gray-400">Dzuhur</div>
                <div id="time-dhuhr" class="text-6xl font-bold font-digital mt-4 text-white">00:00</div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border-t-8 border-green-500 p-8 rounded-3xl text-center shadow-2xl">
                <div class="text-3xl uppercase font-bold text-gray-400">Ashar</div>
                <div id="time-asr" class="text-6xl font-bold font-digital mt-4 text-white">00:00</div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border-t-8 border-orange-500 p-8 rounded-3xl text-center shadow-2xl">
                <div class="text-3xl uppercase font-bold text-gray-400">Maghrib</div>
                <div id="time-maghrib" class="text-6xl font-bold font-digital mt-4 text-white">00:00</div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border-t-8 border-purple-500 p-8 rounded-3xl text-center shadow-2xl">
                <div class="text-3xl uppercase font-bold text-gray-400">Isya</div>
                <div id="time-isha" class="text-6xl font-bold font-digital mt-4 text-white">00:00</div>
            </div>
        </div>
    </main>

    <!-- Running Text (Footer) -->
    <footer class="relative z-30 bg-black py-6 overflow-hidden border-t-2 border-white/10">
        <div id="running-text-container" class="marquee-content text-5xl font-bold text-white">
            Selamat Datang di Masjid Kami • Silahkan Nonaktifkan Handphone Saat Sholat Berlangsung...
        </div>
    </footer>

    <!-- Firebase & Logic Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiM9qD23njTQ6G8m8qzkUsNWRuQPd2SeY",
            authDomain: "ledd-f6b0f.firebaseapp.com",
            projectId: "ledd-f6b0f",
            storageBucket: "ledd-f6b0f.firebasestorage.app",
            messagingSenderId: "341802454320",
            appId: "1:341802454320:web:e0d13b16d14bc1ff5d8cf5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "masjid-v1";

        let localConfig = {};
        let currentYTId = "";
        let prayers = {};

        // Inisialisasi Koordinat & Locale
        moment.locale('id');
        const coordinates = new adhan.Coordinates(-6.2088, 106.8456); // Jakarta
        const params = adhan.CalculationMethod.Singapore();

        // YouTube Iframe Loader
        let player;
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'autoplay': 1, 'controls': 0, 'mute': 1, 'loop': 1, 'modestbranding': 1, 'playlist': '' },
                events: { 'onReady': (e) => e.target.playVideo() }
            });
        };

        // --- FUNGSI UTAMA REALTIME JAM ---
        function updateClockRealtime() {
            const sekarang = moment();
            
            // 1. Update Jam Digital (HH:mm:ss)
            const clockEl = document.getElementById('display-clock');
            if (clockEl) clockEl.innerText = sekarang.format('HH:mm:ss');
            
            // 2. Update Tanggal Masehi (Senin, 1 Januari 2024)
            const dateEl = document.getElementById('display-date');
            if (dateEl) dateEl.innerText = sekarang.format('dddd, D MMMM YYYY');
            
            // 3. Update Kalender Hijriah
            const hijriEl = document.getElementById('display-hijri');
            if (hijriEl) {
                const formatter = new Intl.DateTimeFormat('id-TN-u-ca-islamic-uma-nu-latn', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                hijriEl.innerText = formatter.format(new Date()) + " H";
            }

            // 4. Update Jadwal & Countdown
            renderPrayerTimes();
            handleLogicStates(sekarang);
        }

        function renderPrayerTimes() {
            const adhanTimes = new adhan.PrayerTimes(coordinates, new Date(), params);
            const prayerList = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            
            prayerList.forEach(p => {
                let timeStr = moment(adhanTimes[p]).format('HH:mm');
                
                // Override jika ada pengaturan manual dari Firebase
                if (localConfig.prayerManual?.[p]) {
                    timeStr = localConfig.prayerManual[p];
                }
                
                prayers[p] = timeStr;
                const el = document.getElementById(`time-${p}`);
                if (el) el.innerText = timeStr;
            });
        }

        function handleLogicStates(now) {
            const prayerList = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
            let nextP = null;
            let minDiff = Infinity;
            let activeName = "";
            let isAdzanNow = false;

            prayerList.forEach(p => {
                const pTime = moment(prayers[p], 'HH:mm');
                const diff = pTime.diff(now, 'seconds');

                // Cek Mode "Waktunya Sholat"
                const durasi = localConfig.sholatDuration?.[p] || 5;
                if (now.isSameOrAfter(pTime) && now.isBefore(pTime.clone().add(durasi, 'minutes'))) {
                    isAdzanNow = true;
                    activeName = p;
                }

                // Cari sholat berikutnya
                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextP = p;
                }
            });

            const statusUI = document.getElementById('status-container');
            const modeUI = document.getElementById('sholat-mode');

            if (isAdzanNow) {
                statusUI.classList.add('hidden');
                modeUI.classList.remove('hidden');
                document.getElementById('sholat-name-active').innerText = activeName.toUpperCase();
            } else {
                statusUI.classList.remove('hidden');
                modeUI.classList.add('hidden');
                
                if (nextP) {
                    const label = nextP === 'fajr' ? 'Subuh' : nextP === 'dhuhr' ? 'Dzuhur' : nextP;
                    document.getElementById('next-prayer-name').innerText = `Menuju ${label}`;
                    
                    const duration = moment.duration(minDiff, 'seconds');
                    document.getElementById('prayer-countdown').innerText = 
                        `${String(duration.hours()).padStart(2, '0')}:${String(duration.minutes()).padStart(2, '0')}:${String(duration.seconds()).padStart(2, '0')}`;
                }
            }
        }

        // --- FIREBASE SYNC ---
        async function startApp() {
            // Jalankan jam detik pertama kali
            updateClockRealtime();
            setInterval(updateClockRealtime, 1000);

            try {
                await signInAnonymously(auth);
                
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), (snap) => {
                    if (snap.exists()) {
                        localConfig = snap.data();
                        applyFirebaseConfig();
                    }
                });
            } catch (e) {
                console.error("Firebase Error:", e);
            }
        }

        function applyFirebaseConfig() {
            // 1. Background Color
            document.getElementById('bg-color').style.backgroundColor = localConfig.bgColor || '#000000';
            
            // 2. Background Image
            const bgImg = document.getElementById('bg-image');
            if (localConfig.bgImage) {
                bgImg.style.backgroundImage = `url('${localConfig.bgImage}')`;
                bgImg.style.opacity = '1';
            } else {
                bgImg.style.opacity = '0';
            }

            // 3. Background YouTube
            if (localConfig.bgYoutube && localConfig.bgYoutube !== currentYTId) {
                currentYTId = localConfig.bgYoutube;
                if (player && player.loadVideoById) {
                    player.loadVideoById({ videoId: currentYTId });
                    document.getElementById('youtube-container').classList.replace('opacity-0', 'opacity-100');
                }
            } else if (!localConfig.bgYoutube) {
                currentYTId = "";
                document.getElementById('youtube-container').classList.replace('opacity-100', 'opacity-0');
            }

            // 4. Running Text
            const rt = document.getElementById('running-text-container');
            const teks = localConfig.runningTexts || "Selamat Datang di Masjid Kami";
            rt.innerText = teks.split('|').join(' • ');
            
            // Kecepatan (Speed 1-20)
            const speed = localConfig.runningSpeed || 10;
            const duration = 30 - speed; // Inversi
            rt.style.setProperty('--speed', `${duration}s`);
        }

        window.onload = startApp;
    </script>
</body>
  </html>
