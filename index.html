<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jam Digital Masjid</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/adhan@4.4.3/dist/Adhan.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#000;
  color:#fff;
  height:100vh;
  overflow:hidden;
  font-family:'Plus Jakarta Sans'
}

#marquee{white-space:nowrap;overflow:hidden}
#marquee span{display:inline-block;padding-left:100%}
@keyframes marquee{to{transform:translateX(-100%)}}

.alarm{
  animation:alarmFlash 1s infinite;
}
@keyframes alarmFlash{
  0%{background:#000}
  50%{background:#400}
  100%{background:#000}
}

#bgVideo{
  position:fixed;
  inset:0;
  z-index:-1;
  width:100%;
  height:100%;
  pointer-events:none;
}
</style>
</head>

<body>

<iframe id="bgVideo" allow="autoplay"></iframe>

<div id="main" class="h-screen flex flex-col justify-between px-12 py-8 bg-black/70">

  <div class="text-center">
    <div id="date" class="text-4xl mb-2 text-blue-400"></div>

    <div id="clockWrap">
      <span id="clock" class="font-black text-[18vw]">00:00</span>
      <span id="seconds" class="text-[6vw] ml-4 text-blue-500">00</span>
    </div>

    <div id="sholatText" class="hidden font-black text-[8vw] text-green-400">
      WAKTUNYA SHOLAT
    </div>

    <div id="nextLabel" class="text-3xl mt-2 opacity-70"></div>
    <div id="countdown" class="text-5xl font-bold"></div>
  </div>

  <div class="grid grid-cols-5 gap-6 text-center mt-6">
    <div><div>SUBUH</div><div id="t-fajr" class="text-5xl"></div></div>
    <div><div>DZUHUR</div><div id="t-dhuhr" class="text-5xl"></div></div>
    <div><div>ASHAR</div><div id="t-asr" class="text-5xl"></div></div>
    <div><div>MAGHRIB</div><div id="t-maghrib" class="text-5xl"></div></div>
    <div><div>ISYA</div><div id="t-isha" class="text-5xl"></div></div>
  </div>

  <div id="marquee" class="text-3xl mt-6">
    <span id="runningText"></span>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDiM9qD23njTQ6G8m8qzkUsNWRuQPd2SeY",
  authDomain:"ledd-f6b0f.firebaseapp.com",
  projectId:"ledd-f6b0f"
});

const db = getFirestore(app);
const ref = doc(db,'artifacts','masjid-v1','public','data','config','main');

let conf = {};
let sholatUntil = 0;
let rtIndex = 0;
let lastRT = 0;
let lastBgYoutube = '';

onSnapshot(ref, s=>{
  if(!s.exists()) return;
  conf = s.data();

  /* ===== BACKGROUND (AMAN, TIDAK REFRESH) ===== */

  if(conf.bgYoutube){
    if(lastBgYoutube !== conf.bgYoutube){
      bgVideo.src =
        `https://www.youtube.com/embed/${conf.bgYoutube}?autoplay=1&mute=1&loop=1&playlist=${conf.bgYoutube}`;
      lastBgYoutube = conf.bgYoutube;
    }
  }else{
    if(lastBgYoutube){
      bgVideo.src = '';
      lastBgYoutube = '';
    }
    document.body.style.background = conf.bgColor || '#000';
    document.body.style.backgroundImage =
      conf.bgImage ? `url(${conf.bgImage})` : 'none';
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
  }
});

function manualTime(hhmm){
  const [h,m] = hhmm.split(':');
  let t = moment().hour(+h).minute(+m).second(0);
  if(t.isBefore(moment())) t.add(1,'day');
  return t;
}

setInterval(()=>{
  const now = moment().locale('id');

  clock.innerText = now.format('HH:mm');
  seconds.innerText = now.format('ss');
  date.innerText = now.format('dddd, D MMMM YYYY');

  main.classList.toggle('alarm', !!conf.alarmActive);

  /* ===== RUNNING TEXT ===== */
  if(conf.runningTexts){
    const arr = conf.runningTexts.split('|');
    if(Date.now() - lastRT > (conf.runningSpeed||20)*1000){
      runningText.innerText = arr[rtIndex % arr.length];
      runningText.style.animation =
        `marquee ${conf.runningSpeed||20}s linear infinite`;
      rtIndex++;
      lastRT = Date.now();
    }
  }

  if(!conf.lat || !conf.lng) return;

  const coords = new adhan.Coordinates(+conf.lat,+conf.lng);
  const auto = new adhan.PrayerTimes(
    coords,
    new Date(),
    adhan.CalculationMethod.Singapore()
  );

  const m = conf.prayerManual || {};

  const prayers = [
    {n:'SUBUH',id:'fajr',t:m.fajr?manualTime(m.fajr):moment(auto.fajr)},
    {n:'DZUHUR',id:'dhuhr',t:m.dhuhr?manualTime(m.dhuhr):moment(auto.dhuhr)},
    {n:'ASHAR',id:'asr',t:m.asr?manualTime(m.asr):moment(auto.asr)},
    {n:'MAGHRIB',id:'maghrib',t:m.maghrib?manualTime(m.maghrib):moment(auto.maghrib)},
    {n:'ISYA',id:'isha',t:m.isha?manualTime(m.isha):moment(auto.isha)}
  ];

  prayers.forEach(p=>{
    document.getElementById('t-'+p.id).innerText = p.t.format('HH:mm');
    if(now.isSame(p.t,'minute')){
      sholatUntil = Date.now() + ((conf.sholatDuration||5)*60000);
    }
  });

  if(Date.now() < sholatUntil){
    clockWrap.classList.add('hidden');
    sholatText.classList.remove('hidden');
    nextLabel.innerText = '';
    countdown.innerText = '';
    return;
  }else{
    clockWrap.classList.remove('hidden');
    sholatText.classList.add('hidden');
  }

  let next = prayers.find(p=>p.t.isAfter(now));
  if(!next) next = {...prayers[0], t: prayers[0].t.clone().add(1,'day')};

  const d = moment.duration(next.t.diff(now));
  nextLabel.innerText = 'MENUJU ' + next.n;
  countdown.innerText =
    `${String(d.hours()).padStart(2,'0')}:`+
    `${String(d.minutes()).padStart(2,'0')}:`+
    `${String(d.seconds()).padStart(2,'0')}`;

},1000);
</script>

</body>
</html>
